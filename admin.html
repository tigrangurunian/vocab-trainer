<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin DB - Vocab Trainer</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 24px; background: #0b1020; color: #e6e9f2; }
    h1 { margin-top: 0; }
    .bar { display:flex; gap: 12px; align-items: center; margin-bottom: 16px; }
    button { cursor:pointer; background:#1f2a4d; color:#e6e9f2; border:1px solid #31406d; padding:8px 12px; border-radius:8px; }
    button:hover { background:#273360; }
    input, textarea { width: 100%; background:#101733; color:#e6e9f2; border:1px solid #31406d; border-radius:8px; padding:8px; }
    .layout { display:grid; grid-template-columns: 300px 1fr; gap: 16px; }
    .panel { background:#0f162f; border:1px solid #2a3863; border-radius:12px; padding:12px; }
    ul { list-style:none; padding:0; margin:0; }
    li { padding:6px 8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
    li:hover { background:#131b39; }
    .key { font-weight:600; }
    .muted { color:#9aa4c4; font-size: 12px; }
    .row { display:flex; gap:8px; align-items:center; }
    .danger { background:#421b1b; border-color:#6d3131; }
    .danger:hover { background:#5a2323; }
    .success { background:#1b3f2b; border-color:#2d6d46; }
    .success:hover { background:#24583b; }
    .mono { font-family: ui-monospace, Menlo, Monaco, "Cascadia Mono", Consolas, monospace; font-size: 12px; }
    .footer { margin-top: 16px; color:#9aa4c4; font-size: 12px; }
    .hl { color:#60a5fa; }
  </style>
</head>
<body>
  <h1>Admin DB — <span class="hl">Vocab Trainer</span></h1>
  

  <div class="panel" style="margin-top:16px;">
    <h3>Préférences Utilisateur</h3>
    <div class="row" style="gap:12px;">
      <select id="usersSelect"></select>
      <button id="usersRefreshBtn">Rafraîchir</button>
      <button id="loadPrefsBtn">Charger prefs</button>
    </div>
    <div style="margin-top:8px;">
      <textarea id="prefsTextarea" rows="14" class="mono" placeholder="prefs JSON"></textarea>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="savePrefsBtn" class="success">Enregistrer prefs</button>
    </div>
  </div>

  <div class="panel" style="margin-top:16px;">
    <h3>Utilisateurs (CRUD)</h3>
    <div class="row" style="gap:12px;">
      <input id="newUserName" placeholder="Nom utilisateur" />
      <button id="createUserBtn" class="success">Créer</button>
      <button id="reloadUsersBtn">Recharger</button>
    </div>
    <ul id="adminUsersList" style="margin-top:8px;"></ul>
  </div>

  <div class="panel" style="margin-top:16px;">
    <h3>Vocabulaires / Decks (CRUD)</h3>
    <div class="row" style="gap:12px;">
      <input id="newDeckName" placeholder="Nom du vocabulaire" />
      <button id="createDeckBtn" class="success">Créer</button>
      <button id="reloadDecksBtn">Recharger</button>
    </div>
    <ul id="adminDecksList" style="margin-top:8px;"></ul>
  </div>

  <div class="panel" style="margin-top:16px;">
    <h3>Mots</h3>
    <div class="row" style="gap:12px;">
      <label class="muted">Deck:</label>
      <select id="wordsDeckSelect"></select>
      <button id="reloadWordsBtn">Recharger</button>
      <button id="clearDeckWordsBtn" class="danger">Vider ce deck</button>
    </div>
    <div class="row" style="gap:12px; margin-top:8px;">
      <input id="newWordFr" placeholder="Français (ex: pomme)" />
      <input id="newWordEn" placeholder="Traductions séparées par des virgules (ex: apple, apples)" />
      <button id="createWordBtn" class="success">Ajouter</button>
    </div>
    <ul id="adminWordsList" style="margin-top:8px;"></ul>
  </div>

  <div class="panel" style="margin-top:16px;">
    <h3>Historique (Reviews)</h3>
    <div class="row" style="gap:12px;">
      <label class="muted">Deck:</label>
      <select id="reviewsDeckSelect"></select>
      <label class="muted">Utilisateur:</label>
      <select id="reviewsUserFilter"><option value="">— Tous —</option></select>
      <button id="reloadReviewsBtn">Recharger</button>
      <button id="clearDeckReviewsBtn" class="danger">Effacer historique du deck</button>
    </div>
    <ul id="adminReviewsList" style="margin-top:8px;"></ul>
  </div>

  <div class="footer">
    Admin: Utilisateurs, Decks, Mots et Préférences — Health: /api/health
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const usersSelect = $('#usersSelect');
    const prefsTextarea = $('#prefsTextarea');

    async function api(path, opts) {
      const res = await fetch(path, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
    }

    

    // ---- Users prefs admin ----
    async function refreshUsersList() {
      try {
        const data = await api('/api/users');
        usersSelect.innerHTML = '';
        (data.items || []).forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = `${u.name} (${u.id})`;
          usersSelect.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        setStatus('Erreur chargement utilisateurs: ' + e.message);
      }
    }

    async function loadPrefsForSelected() {
      const id = usersSelect.value;
      if (!id) return alert('Choisir un utilisateur');
      setStatus('Chargement prefs...');
      try {
        const res = await fetch(`/api/users/${encodeURIComponent(id)}/prefs`);
        if (res.status === 404) {
          prefsTextarea.value = '';
          setStatus('Aucune prefs pour cet utilisateur');
          return;
        }
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        prefsTextarea.value = JSON.stringify(data.prefs || {}, null, 2);
        setStatus('OK');
      } catch (e) {
        setStatus('Erreur: ' + e.message);
      }
    }

    async function savePrefsForSelected() {
      const id = usersSelect.value;
      if (!id) return alert('Choisir un utilisateur');
      let parsed;
      try { parsed = prefsTextarea.value.trim() ? JSON.parse(prefsTextarea.value) : {}; }
      catch(e) { return alert('JSON invalide: ' + e.message); }
      setStatus('Enregistrement prefs...');
      try {
        await api(`/api/users/${encodeURIComponent(id)}/prefs`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prefs: parsed })
        });
        setStatus('Prefs enregistrées');
      } catch (e) {
        setStatus('Erreur: ' + e.message);
      }
    }

    document.getElementById('usersRefreshBtn').addEventListener('click', refreshUsersList);
    document.getElementById('loadPrefsBtn').addEventListener('click', loadPrefsForSelected);
    document.getElementById('savePrefsBtn').addEventListener('click', savePrefsForSelected);

    refreshUsersList();

    // ---- Users CRUD ----
    async function adminReloadUsers() {
      const data = await api('/api/users');
      const ul = document.getElementById('adminUsersList');
      ul.innerHTML = '';
      (data.items || []).forEach(u => {
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.innerHTML = `<div class="key">${u.name}</div><div class="muted">id: ${u.id}</div>`;
        const right = document.createElement('div');
        const del = document.createElement('button');
        del.className = 'danger';
        del.textContent = 'Supprimer';
        del.addEventListener('click', async () => {
          if (!confirm(`Supprimer l'utilisateur "${u.name}" ?`)) return;
          const res = await fetch(`/api/users/${encodeURIComponent(u.id)}`, { method: 'DELETE' });
          if (!res.ok) return alert(await res.text());
          adminReloadUsers();
          refreshUsersList();
        });
        right.appendChild(del);
        li.appendChild(left);
        li.appendChild(right);
        ul.appendChild(li);
      });
    }
    document.getElementById('reloadUsersBtn').addEventListener('click', adminReloadUsers);
    document.getElementById('createUserBtn').addEventListener('click', async () => {
      const name = (document.getElementById('newUserName').value || '').trim();
      if (!name) return alert('Nom requis');
      const res = await fetch('/api/users', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name })
      });
      if (res.status === 409) return alert('Nom déjà existant');
      if (!res.ok) return alert(await res.text());
      document.getElementById('newUserName').value = '';
      adminReloadUsers();
      refreshUsersList();
    });
    adminReloadUsers();

    // ---- Decks CRUD ----
    async function adminReloadDecks() {
      const data = await api('/api/decks');
      const ul = document.getElementById('adminDecksList');
      ul.innerHTML = '';
      const select = document.getElementById('wordsDeckSelect');
      select.innerHTML = '';
      (data.items || []).forEach(d => {
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.innerHTML = `<div class="key">${d.name}</div><div class="muted">id: ${d.id}</div>`;
        const right = document.createElement('div');
        const del = document.createElement('button');
        del.className = 'danger';
        del.textContent = 'Supprimer';
        del.addEventListener('click', async () => {
          if (!confirm(`Supprimer le vocabulaire "${d.name}" ?`)) return;
          const res = await fetch(`/api/decks/${encodeURIComponent(d.id)}`, { method: 'DELETE' });
          if (!res.ok) return alert(await res.text());
          adminReloadDecks();
        });
        right.appendChild(del);
        li.appendChild(left);
        li.appendChild(right);
        ul.appendChild(li);
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = d.name; select.appendChild(opt);
      });
      // Après rechargement des decks, recharger les mots du deck courant si sélectionné
      if (select.value) adminReloadWords();
    }
    document.getElementById('reloadDecksBtn').addEventListener('click', adminReloadDecks);
    document.getElementById('createDeckBtn').addEventListener('click', async () => {
      const name = (document.getElementById('newDeckName').value || '').trim();
      if (!name) return alert('Nom requis');
      const res = await fetch('/api/decks', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name })
      });
      if (res.status === 409) return alert('Nom déjà existant');
      if (!res.ok) return alert(await res.text());
      document.getElementById('newDeckName').value = '';
      adminReloadDecks();
    });
    adminReloadDecks();

    // ---- Words CRUD ----
    async function adminReloadWords() {
      const deckId = document.getElementById('wordsDeckSelect').value;
      const ul = document.getElementById('adminWordsList');
      ul.innerHTML = '';
      if (!deckId) return;
      const res = await fetch(`/api/decks/${encodeURIComponent(deckId)}/words`);
      if (!res.ok) { ul.innerHTML = '<li class="muted">Erreur de chargement</li>'; return; }
      const data = await res.json();
      (data.items || []).forEach(w => {
        const li = document.createElement('li');
        const left = document.createElement('div');
        const en = Array.isArray(w.en) ? w.en.join(', ') : '';
        left.innerHTML = `<div class="key">${w.fr} → ${en}</div><div class="muted">id: ${w.id}</div>`;
        const right = document.createElement('div');
        const del = document.createElement('button');
        del.className = 'danger';
        del.textContent = 'Supprimer';
        del.addEventListener('click', async () => {
          if (!confirm(`Supprimer le mot "${w.fr}" ?`)) return;
          const r = await fetch(`/api/words/${encodeURIComponent(w.id)}`, { method: 'DELETE' });
          if (!r.ok) return alert(await r.text());
          adminReloadWords();
        });
        right.appendChild(del);
        li.appendChild(left);
        li.appendChild(right);
        ul.appendChild(li);
      });
    }
    document.getElementById('wordsDeckSelect').addEventListener('change', adminReloadWords);
    document.getElementById('reloadWordsBtn').addEventListener('click', adminReloadWords);
    document.getElementById('createWordBtn').addEventListener('click', async () => {
      const deckId = document.getElementById('wordsDeckSelect').value;
      if (!deckId) return alert('Choisir un deck');
      const fr = (document.getElementById('newWordFr').value || '').trim();
      const enRaw = (document.getElementById('newWordEn').value || '').trim();
      if (!fr) return alert('Français requis');
      const en = enRaw ? enRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
      const res = await fetch(`/api/decks/${encodeURIComponent(deckId)}/words`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fr, en })
      });
      if (!res.ok) return alert(await res.text());
      document.getElementById('newWordFr').value = '';
      document.getElementById('newWordEn').value = '';
      adminReloadWords();
    });
    document.getElementById('clearDeckWordsBtn').addEventListener('click', async () => {
      const deckId = document.getElementById('wordsDeckSelect').value;
      if (!deckId) return alert('Choisir un deck');
      if (!confirm('Vider tous les mots de ce deck ?')) return;
      const res = await fetch(`/api/decks/${encodeURIComponent(deckId)}/words`, { method: 'DELETE' });
      if (!res.ok) return alert(await res.text());
      adminReloadWords();
    });

    // ---- Reviews admin ----
    async function seedReviewsSelectors() {
      // decks
      const decks = await api('/api/decks');
      const dsel = document.getElementById('reviewsDeckSelect');
      dsel.innerHTML = '';
      (decks.items || []).forEach(d => {
        const o = document.createElement('option');
        o.value = d.id; o.textContent = d.name; dsel.appendChild(o);
      });
      // users
      const users = await api('/api/users');
      const usel = document.getElementById('reviewsUserFilter');
      // keep "Tous"
      Array.from(usel.querySelectorAll('option:not([value=""])')).forEach(n => n.remove());
      (users.items || []).forEach(u => {
        const o = document.createElement('option');
        o.value = u.id; o.textContent = u.name; usel.appendChild(o);
      });
    }

    async function adminReloadReviews() {
      const deckId = document.getElementById('reviewsDeckSelect').value;
      const userId = document.getElementById('reviewsUserFilter').value;
      const ul = document.getElementById('adminReviewsList');
      ul.innerHTML = '';
      if (!deckId) return;
      const res = await fetch(`/api/decks/${encodeURIComponent(deckId)}/reviews`);
      if (!res.ok) { ul.innerHTML = '<li class="muted">Erreur de chargement</li>'; return; }
      let data = (await res.json()).items || [];
      if (userId) data = data.filter(r => r.userId === userId);
      if (!data.length) { ul.innerHTML = '<li class="muted">Aucun historique</li>'; return; }
      data.forEach(r => {
        const li = document.createElement('li');
        const dt = new Date(r.startedAt).toLocaleString();
        const fp = r.summary?.firstPassPct ?? 0;
        const err = r.summary?.errorsTotal ?? 0;
        const mins = Math.max(1, Math.round((r.durationMs || 0) / 60000));
        li.innerHTML = `<div class="key">${dt}</div><div class="muted">Q: ${r.totalQuestions} • 1er coup: ${fp}% • Err: ${err} • Durée: ${mins} min</div>`;
        ul.appendChild(li);
      });
    }

    document.getElementById('reloadReviewsBtn').addEventListener('click', adminReloadReviews);
    document.getElementById('reviewsDeckSelect').addEventListener('change', adminReloadReviews);
    document.getElementById('reviewsUserFilter').addEventListener('change', adminReloadReviews);
    document.getElementById('clearDeckReviewsBtn').addEventListener('click', async () => {
      const deckId = document.getElementById('reviewsDeckSelect').value;
      if (!deckId) return alert('Choisir un deck');
      if (!confirm('Effacer tout l\'historique de ce deck ?')) return;
      const r = await fetch(`/api/decks/${encodeURIComponent(deckId)}/reviews`, { method: 'DELETE' });
      if (!r.ok) return alert(await r.text());
      adminReloadReviews();
    });

    // init reviews selectors and list
    seedReviewsSelectors().then(adminReloadReviews);
  </script>
</body>
</html>
